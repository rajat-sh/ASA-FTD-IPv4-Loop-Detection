# Cisco ASA/FTD Duplicate Packet & Loop Detector

This Bash script is a high-performance diagnostic utility designed to identify duplicate packets and potential routing loops within network traffic. It can analyze both binary capture files (PCAP) and text-based diagnostic outputs from Cisco security appliances.

---

## üîç Overview

Packet duplication and routing loops are common symptoms of network misconfigurations, spanning-tree issues, or security policy errors. This script detects these conditions by tracking **IP Identification (IP ID)** fields across unique Source and Destination IP pairs. If the same IP ID appears multiple times for the same flow (and is not a fragment), it is flagged as a duplicate/looping packet.

### Supported Input Formats:

1. **PCAP:** Standard packet capture files generated by tools like `tcpdump`, Wireshark, or Cisco's internal capture engine.
2. **Text:** Output from the Cisco CLI command `show capture <capname> detail`.

---

## ‚ú® Features

* **Hybrid Analysis:** Seamlessly switches between binary PCAP parsing and text-based log parsing.
* **Large File Optimization:** Automatically detects files larger than 100MB and utilizes `tcpdump` splitting combined with **GNU Parallel** to process data using multiple CPU cores.
* **Intelligent Filtering:** * Ignores packets with `IP ID 0` (often used in modern stacks where ID isn't required).
* Filters out fragments to ensure that reassembled parts aren't mistaken for loops.


* **Formatted Reporting:** Generates a clean table showing the recurrence count, Source IP, Destination IP, and the specific IP ID responsible.

---

## üöÄ Usage

### For PCAP Files:

```bash
./detect_loops.sh pcap traffic_dump.pcap

```

### For Cisco CLI Text Output:

Ensure you capture the output using the `detail` keyword on the ASA/FTD:

```bash
./detect_loops.sh text capture_output.txt

```

---

## üìñ How It Works

### 1. PCAP Path

The script uses `tshark` to extract the fields `ip.src`, `ip.dst`, `ip.id`, and `ip.flags.mf`.

* **Small Files:** Processed in a single stream.
* **Large Files:** The script splits the PCAP into smaller chunks and uses `parallel` to run multiple instances of `tshark` simultaneously, aggregating the results in an `awk` associative array.

### 2. Text Path

The script parses the `show capture ... detail` output. It looks for lines containing `ttl` (Time to Live) and extracts the IP addresses and the ID field (e.g., `(id 12345)`). It uses string manipulation to normalize the Cisco CLI formatting before counting.

### 3. Loop Detection Logic

A packet is considered a "duplicate" if the following tuple is identical across multiple packets:



If the count for this tuple is , the script outputs the flow details for further investigation.

---

## üìã Example Output

```text
Count    Source IP       Destination IP  IP Identification
-----    --------------- --------------- ------------------
4        10.1.1.5        192.168.10.20   0x4af2
2        172.16.5.1      10.50.50.1      0x12bc

```

---

## üõ† Prerequisites

* **tshark:** Part of the Wireshark suite.
* **tcpdump:** For splitting large files.
* **GNU Parallel:** (Optional but recommended) For high-speed analysis of large captures.
* **awk:** Standard on most Linux distributions.


